#!/bin/bash

set -eu

worker_dir="$( cd "$( dirname "$0" )" && cd .. && pwd )"
releases_index="${worker_dir}/../releases/index.yml"

echo "If this fails run: fly -t bosh-io login -c https://ci.bosh-ecosystem.cf-app.com -n team-bosh-io"
fly -t bosh-io status

echo
echo "Pulling latest releases/index.yml..."
pushd "$( dirname "$releases_index" )" >/dev/null
  git pull --ff-only
popd >/dev/null

echo
echo "Checking lpass status...."
if [[ $(lpass status -q; echo $?) != 0 ]]; then
  echo "Login with lpass first"
  exit 1
fi

echo
echo "Synchronizing pipelines..."

pushd ./src/worker >/dev/null
  while read org; do
    lowerOrg=$(echo "${org}" | tr '[:upper:]' '[:lower:]')
    echo "$org..."

    fly -t bosh-io set-pipeline -n \
      -p "releases-${lowerOrg}" \
      -c <( go run main/generatepipeline/main.go "$releases_index" "$org" ) \
      -l <( lpass show bosh-io-pipelines-reconfigure-secrets --notes )
  done < <( set -eu
    go run main/indexorgs/main.go "$releases_index"
  )
popd >/dev/null

echo
echo "Done"
